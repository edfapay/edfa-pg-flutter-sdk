// https://jitpack.io/docs/ANDROID/#examples
group 'com.edfapg.flutter.sdk'
version '1.0.0'

buildscript {
    ext.kotlin_version = '1.8.0'
    repositories {
        google()
        mavenCentral()
    }

    dependencies {
        classpath 'com.android.tools.build:gradle:7.2.2'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
        classpath "org.yaml:snakeyaml:2.0"

    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        maven { url 'https://jitpack.io' }
    }
}

import org.yaml.snakeyaml.Yaml


apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'

def getPgSdkVersion() {
    def pg_android_fallback = "2.1.+"
    println("[EdfaPay] Extracting android native sdk version from project pubspec.yaml")

    def projectDir = rootProject.projectDir
    def yamlFile = file("$projectDir/../pubspec.yaml")
    println("[EdfaPay] Project yaml >>> $yamlFile")
    if (!yamlFile.exists()) {
        println("[EdfaPay] Project yaml not exist using fallback version >>> $pg_android_fallback")
        return pg_android_fallback
    }
    def yamlContent = new String(yamlFile.readBytes())
    def yaml = new Yaml()
    def data = yaml.load(yamlContent)
    def version = data["edfapay_properties"]?["pg_android"]
    if(version == null){
        println("[EdfaPay] Project yaml does not contains `edfapay_properties.pg_android`, using fallback version >>> $pg_android_fallback")
        return pg_android_fallback
    }else
        return version
}

def root = rootProject
android {
    compileSdk 36
    namespace 'com.edfapg.flutter.sdk'

    defaultConfig {
        minSdk 24
        targetSdk 36

        aarMetadata {
            minCompileSdk = 16
        }

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    buildFeatures {
        viewBinding true
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
    }

    defaultConfig {
        minSdkVersion 21
    }

    dependencies {
        implementation "com.github.edfapay:edfa-pg-android-sdk:${getPgSdkVersion()}"
//        implementation 'com.edfapg:sdk:1.0.5' // Local Repository
//        implementation project(path: ':edfa-pg-sdk') // Local Module
        implementation 'com.google.code.gson:gson:2.9.0'
    }
}

//beforeEvaluate {
//    rootProject.allprojects.findAll { it.plugins.hasPlugin("com.android.application") }.each { appModule ->
//        def androidExt = appModule.extensions.findByName("android")
//        if (androidExt != null) {
//            def minSdk = androidExt.defaultConfig.minSdkVersion.apiLevel
//
//            // Only enable desugaring if needed
//            if (minSdk < 26 || minSdk >= 26) {
//                def compileOptions = androidExt.compileOptions
//
//                // Enable only if not already true
//                if (!compileOptions.coreLibraryDesugaringEnabled) {
//                    appModule.logger.lifecycle("ðŸ”§ Enabling core library desugaring for ${appModule.name} (minSdk=$minSdk)")
//                    compileOptions.coreLibraryDesugaringEnabled true
//                }
//
//                // Add dependency only if not already added
//                def hasDesugarDep = appModule.configurations.findByName("coreLibraryDesugaring")
//                        ?.dependencies
//                        ?.any { it.group == "com.android.tools" && it.name == "desugar_jdk_libs" } ?: false
//
//                if (!hasDesugarDep) {
//                    appModule.logger.lifecycle("ðŸ”§ Adding desugar_jdk_libs dependency for ${appModule.name}")
//                    appModule.dependencies.add("coreLibraryDesugaring", "com.android.tools:desugar_jdk_libs:2.0.4")
//                }
//            } else {
//                appModule.logger.lifecycle("âœ… ${appModule.name} has minSdk=$minSdk, desugaring not needed, if still warn by gradle you can add manually as below")
//                appModule.logger.lifecycle("""
//    android {
//         ...
//         compileOptions {
//             isCoreLibraryDesugaringEnabled = true // For .gradle.kts
//             coreLibraryDesugaringEnabled = true // For .gradle
//         }
//         ...
//    }
//""")
//
//                appModule.logger.lifecycle("""
//    dependencies {
//        coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:2.1.5")
//    }
//""")
//            }
//        }
//    }
//}